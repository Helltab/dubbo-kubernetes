import{u as ue}from"./index-DQrdMhlF.js";import{d as de,l as re,m as pe,b as _e,Q as fe,s as ye,g as ve,u as be,n as R,r as he,w as Y,f as H,c as e,t as a,e as u,o as g,z as b,v as w,h as A,a6 as me,a7 as ke,F as ge,y as we,J as x,B,I as L,K as P,G as xe,H as Ce,_ as $e}from"./index-eYv_Far2.js";import{e as Oe,h as Ke}from"./traffic-XuFzmEwh.js";import"./request-WeLgEOdi.js";const N=S=>(xe("data-v-4d75d4d5"),S=S(),Ce(),S),Re={class:"__container_tagRule_detail"},Ue={style:{"max-width":"400px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Ee=N(()=>x("br",null,null,-1)),Ne=N(()=>x("br",null,null,-1)),Te=N(()=>x("br",null,null,-1)),je=N(()=>x("br",null,null,-1)),Ae=N(()=>x("br",null,null,-1)),Se=N(()=>x("br",null,null,-1)),De={class:"bottom-action-footer"},Ve=de({__name:"updateByFormView",setup(S){const $=re(pe.PROVIDE_INJECT_KEY),M=_e();fe(async()=>{if(ye.isNil($.tagRule))await F();else{const{enabled:t=!0,key:l,scope:d,runtime:p=!0,tags:o}=$.tagRule;s.enable=t,s.objectOfAction=l,s.ruleGranularity=d,s.runtime=p,console.log("tags",o),o&&o.length&&o.forEach((h,_)=>{r.value.push({tagName:h.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:f}=h;let c=[];f.forEach((i,y)=>{c.push({myKey:i.key,condition:Object.keys(i.value)[0],value:i.value[Object.keys(i.value)[0]]})}),r.value[_]&&r.value[_].scope&&(r.value[_].scope.labels=c)})}}),ve();const z=be(),U=R(!1),G=R(8);ue().toClipboard;const q=(t,l)=>{var o,h,_,f;let d=`对于应用 ${l||"未指定"}，将满足 `;const p=[];if(((o=t.scope)==null?void 0:o.type)==="labels"&&((h=t.scope.labels)==null?void 0:h.length)>0)t.scope.labels.forEach(c=>{var k,m;let i="";if(c.myKey==="method")i="请求方法";else if((k=c.myKey)!=null&&k.startsWith("args[")){const T=(m=c.myKey.match(/\[(\d+)\]/))==null?void 0:m[1];T!==void 0?i=`第 ${parseInt(T)+1} 个参数`:i=`标签 ${c.myKey||"未指定"}`}else i=`标签 ${c.myKey||"未指定"}`;let y="";const v=c.value||"未指定";switch(c.condition){case"exact":y=`exact ${v}`;break;case"regex":y=`regex ${v}`;break;case"prefix":y=`prefix ${v}`;break;case"noempty":y="noempty";break;case"empty":y="empty";break;case"wildcard":y=`wildcard ${v}`;break;case"!=":y=`!= ${v}`;break;default:y=`${c.condition||"未知关系"} ${v}`}c.condition!=="empty"&&c.condition!=="noempty"&&!c.value?p.push(`${i} 未填写`):p.push(`${i} ${y}`)});else if(((_=t.scope)==null?void 0:_.type)==="addresses"&&((f=t.scope.addresses)!=null&&f.addressesStr)){const c=t.scope.addresses.condition==="="?"等于":"不等于";p.push(`地址 ${c} [${t.scope.addresses.addressesStr}]`)}return p.length===0?d+="任意请求":d+=p.join(" 且 "),d+=` 的实例，打上 ${t.tagName||"未指定"} 标签，划入 ${t.tagName||"未指定"} 的隔离环境`,d},s=he({ruleGranularity:"application",objectOfAction:"shop-user",enable:!0,faultTolerantProtection:!0,runtime:!0,priority:1,configVersion:""});Y(s,t=>{const{enable:l,objectOfAction:d,runtime:p,ruleGranularity:o}=t;$.tagRule={...$.tagRule,enabled:l,key:d,runtime:p,scope:o}});const Q=R([{label:"labels",value:"labels"}]),W=R([{label:"exact",value:"exact"},{label:"regex",value:"regex"},{label:"prefix",value:"prefix"},{label:"noempty",value:"noempty"},{label:"empty",value:"empty"},{label:"wildcard",value:"wildcard"}]),X=R([{label:"=",value:"="},{label:"!=",value:"!="}]),Z=R([{title:"键",dataIndex:"myKey",key:"myKey"},{title:"关系",dataIndex:"condition",key:"condition"},{title:"值",dataIndex:"value",key:"value"},{title:"操作",dataIndex:"operation",key:"operation"}]),r=R([]);Y(r,t=>{console.log(t);const l=[];t.forEach(d=>{const{tagName:p,scope:o}=d,h=o.labels,_={name:p,match:[]};h&&h.length>0&&h.forEach(f=>{_.match.push({key:f.myKey,value:{[f.condition]:f.value}})}),l.push(_)}),$.tagRule={...$.tagRule,tags:l},console.log("watch tagList",$.tagRule)},{deep:!0});const I=(t,l)=>{if(r.value[t].scope.labels.length===1){r.value[t].scope.type="addresses";return}r.value[t].scope.labels.splice(l,1)},ee=t=>{r.value[t].scope.labels.push({myKey:"",condition:"exact",value:""})},ae=()=>{r.value.push({tagName:"",scope:{type:"labels",labels:[{myKey:"",condition:"",value:""}],addresses:{condition:"",addressesStr:""}}})},te=t=>{r.value.splice(t,1)},F=async()=>{var l;const t=await Oe((l=z.params)==null?void 0:l.ruleName);if(t.code===200){const{configVersion:d,enabled:p,key:o,runtime:h,scope:_,tags:f}=t==null?void 0:t.data;s.configVersion=d,s.enable=p,s.runtime=h,s.ruleGranularity=_,s.objectOfAction=o,r.value=[],f.forEach((c,i)=>{r.value.push({tagName:c.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:y}=c;let v=[];y.forEach((k,m)=>{v.push({myKey:k.key,condition:Object.keys(k.value)[0],value:k.value[Object.keys(k.value)[0]]})}),r.value[i]&&r.value[i].scope&&(r.value[i].scope.labels=v)})}},le=async()=>{var i;const{ruleGranularity:t,objectOfAction:l,enable:d,faultTolerantProtection:p,runtime:o,priority:h,configVersion:_}=s,f={configVersion:_,scope:t,key:l,enabled:d,runtime:o,tags:[]};r.value.forEach((y,v)=>{const k={name:y.tagName,match:[]};y.scope.labels.forEach((m,T)=>{const D={key:m.myKey,value:{}};D.value[m.condition]=m.value,k.match.push(D)}),f.tags.push(k)}),(await Ke((i=z.params)==null?void 0:i.ruleName,f)).code===200&&(await F(),M.push("/traffic/tagRule"))};return(t,l)=>{const d=u("a-button"),p=u("a-flex"),o=u("a-form-item"),h=u("a-switch"),_=u("a-col"),f=u("a-input"),c=u("a-input-number"),i=u("a-row"),y=u("a-form"),v=u("a-card"),k=u("a-tooltip"),m=u("a-space"),T=u("a-radio-group"),D=u("a-tag"),J=u("a-select"),oe=u("a-table"),ne=u("a-textarea"),V=u("a-descriptions-item"),se=u("a-descriptions"),ce=u("a-affix");return g(),H("div",Re,[e(p,{style:{width:"100%"}},{default:a(()=>[e(_,{span:U.value?24-G.value:24,class:"left"},{default:a(()=>[e(v,null,{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical",size:"middle"},{default:a(()=>[e(i,null,{default:a(()=>[e(p,{justify:"end",style:{width:"100%"}},{default:a(()=>[e(d,{type:"text",style:{color:"#0a90d5"},onClick:l[0]||(l[0]=n=>U.value=!U.value)},{default:a(()=>[b(" 字段说明 "),U.value?(g(),w(A(ke),{key:1})):(g(),w(A(me),{key:0}))]),_:1})]),_:1}),e(v,{title:"基础信息",style:{width:"100%"},class:"_detail"},{default:a(()=>[e(y,{layout:"horizontal"},{default:a(()=>[e(i,{style:{width:"100%"}},{default:a(()=>[e(_,{span:12},{default:a(()=>[e(o,{label:"规则粒度",required:""},{default:a(()=>[b(" 应用")]),_:1}),e(o,{label:"容错保护"},{default:a(()=>[e(h,{checked:s.faultTolerantProtection,"onUpdate:checked":l[1]||(l[1]=n=>s.faultTolerantProtection=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(o,{label:"运行时生效"},{default:a(()=>[e(h,{checked:s.runtime,"onUpdate:checked":l[2]||(l[2]=n=>s.runtime=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})]),_:1}),e(_,{span:12},{default:a(()=>[e(o,{label:"作用对象",required:""},{default:a(()=>[e(f,{disabled:"",value:s.objectOfAction,"onUpdate:value":l[3]||(l[3]=n=>s.objectOfAction=n),style:{width:"200px"}},null,8,["value"])]),_:1}),e(o,{label:"立即启用"},{default:a(()=>[e(h,{checked:s.enable,"onUpdate:checked":l[4]||(l[4]=n=>s.enable=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(o,{label:"优先级"},{default:a(()=>[e(c,{min:"1",value:s.priority,"onUpdate:value":l[5]||(l[5]=n=>s.priority=n)},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(v,{title:"标签列表",style:{width:"100%"},class:"_detail"},{default:a(()=>[(g(!0),H(ge,null,we(r.value,(n,j)=>(g(),w(v,{key:j},{title:a(()=>[e(m,{align:"center"},{default:a(()=>[x("div",null,"路由【"+B(j+1)+"】",1),e(k,null,{title:a(()=>[b(B(q(n,s.objectOfAction)),1)]),default:a(()=>[x("div",Ue,B(q(n,s.objectOfAction)),1)]),_:2},1024)]),_:2},1024)]),default:a(()=>[e(y,{layout:"horizontal"},{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical",size:"large"},{default:a(()=>[e(p,{justify:"end"},{default:a(()=>[e(A(L),{onClick:O=>te(j),class:"action-icon",icon:"tdesign:delete"},null,8,["onClick"])]),_:2},1024),e(o,{label:"标签名",required:""},{default:a(()=>[e(f,{placeholder:"隔离环境名",value:n.tagName,"onUpdate:value":O=>n.tagName=O},null,8,["value","onUpdate:value"])]),_:2},1024),e(o,{label:"作用范围",required:""},{default:a(()=>[e(v,null,{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical"},{default:a(()=>[e(o,{label:"匹配条件类型"},{default:a(()=>[e(T,{value:n.scope.type,"onUpdate:value":O=>n.scope.type=O,options:Q.value},null,8,["value","onUpdate:value","options"])]),_:2},1024),e(m,{align:"start",style:{width:"100%"},direction:"horizontal"},{default:a(()=>{var O;return[e(D,{bordered:!1,color:"processing"},{default:a(()=>[b(B(n.scope.type),1)]),_:2},1024),n.scope.type==="labels"?(g(),w(oe,{key:0,pagination:!1,columns:Z.value,"data-source":(O=n.scope)==null?void 0:O.labels},{bodyCell:a(({column:C,record:E,text:Be,index:ie})=>[C.key==="myKey"?(g(),w(f,{key:0,placeholder:"label key",value:E.myKey,"onUpdate:value":K=>E.myKey=K},null,8,["value","onUpdate:value"])):P("",!0),C.key==="condition"?(g(),w(J,{key:1,value:E.condition,"onUpdate:value":K=>E.condition=K,style:{width:"120px"},options:W.value},null,8,["value","onUpdate:value","options"])):P("",!0),C.key==="value"?(g(),w(f,{key:2,placeholder:"label value",value:E.value,"onUpdate:value":K=>E.value=K},null,8,["value","onUpdate:value"])):C.key==="operation"?(g(),w(m,{key:3,align:"center"},{default:a(()=>[e(A(L),{icon:"tdesign:remove",class:"action-icon",onClick:K=>I(j,ie)},null,8,["onClick"]),e(A(L),{class:"action-icon",icon:"tdesign:add",onClick:K=>ee(j)},null,8,["onClick"])]),_:2},1024)):P("",!0)]),_:2},1032,["columns","data-source"])):(g(),w(m,{key:1,align:"start"},{default:a(()=>[e(J,{style:{width:"120px"},value:n.scope.addresses.condition,"onUpdate:value":C=>n.scope.addresses.condition=C,options:X.value},null,8,["value","onUpdate:value","options"]),e(ne,{style:{width:"500px"},value:n.scope.addresses.addressesStr,"onUpdate:value":C=>n.scope.addresses.addressesStr=C,placeholder:'地址列表，如有多个用"，"隔开'},null,8,["value","onUpdate:value"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(d,{onClick:ae,type:"primary"},{default:a(()=>[b(" 增加标签")]),_:1})]),_:1})]),_:1})]),_:1},8,["span"]),e(_,{span:U.value?G.value:0,class:"right"},{default:a(()=>[U.value?(g(),w(v,{key:0,class:"sliderBox"},{default:a(()=>[x("div",null,[e(se,{title:"字段说明",column:1},{default:a(()=>[e(V,{label:"key"},{default:a(()=>[b(" 作用对象"),Ee,b(" 可能的值：Dubbo应用名或者服务名 ")]),_:1}),e(V,{label:"scope"},{default:a(()=>[b(" 规则粒度"),Ne,b(" 可能的值：application, service ")]),_:1}),e(V,{label:"force"},{default:a(()=>[b(" 容错保护"),Te,b(" 可能的值：true, false"),je,b(" 描述：如果为true，则路由筛选后若没有可用的地址则会直接报异常；如果为false，则会从可用地址中选择完成RPC调用 ")]),_:1}),e(V,{label:"runtime"},{default:a(()=>[b(" 运行时生效"),Ae,b(" 可能的值：true, false"),Se,b(" 描述：如果为true，则该rule下的所有路由将会实时生效；若为false，则只有在启动时才会生效 ")]),_:1})]),_:1})])]),_:1})):P("",!0)]),_:1},8,["span"])]),_:1}),e(ce,{"offset-bottom":10},{default:a(()=>[x("div",De,[e(m,{align:"center",size:"large"},{default:a(()=>[e(d,{type:"primary",onClick:le},{default:a(()=>[b(" 确认")]),_:1}),e(d,null,{default:a(()=>[b(" 取消")]),_:1})]),_:1})])]),_:1})])}}}),qe=$e(Ve,[["__scopeId","data-v-4d75d4d5"]]);export{qe as default};
