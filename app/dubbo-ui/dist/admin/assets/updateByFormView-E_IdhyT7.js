import{u as ie}from"./index-SZY9EzGQ.js";import{d as ue,l as de,m as re,b as pe,Q as _e,s as fe,g as ye,u as ve,n as U,r as be,w as Y,f as H,c as e,t as a,e as u,o as g,z as b,v as w,h as A,a6 as he,a7 as me,F as ke,y as ge,J as x,B,I as L,K as P,X as we,G as xe,H as Ce,_ as $e}from"./index-2PcYiHuV.js";import{e as Oe,h as Ke}from"./traffic-AlFSaPpV.js";import"./request-6GC6eYb8.js";const R=S=>(xe("data-v-5efc185c"),S=S(),Ce(),S),Ue={class:"__container_tagRule_detail"},Ee={style:{"max-width":"400px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Ne=R(()=>x("br",null,null,-1)),Re=R(()=>x("br",null,null,-1)),Te=R(()=>x("br",null,null,-1)),je=R(()=>x("br",null,null,-1)),Ae=R(()=>x("br",null,null,-1)),Se=R(()=>x("br",null,null,-1)),De={class:"bottom-action-footer"},Ve=ue({__name:"updateByFormView",setup(S){const $=de(re.PROVIDE_INJECT_KEY);pe(),_e(async()=>{if(fe.isNil($.tagRule))await F();else{const{enabled:t=!0,key:l,scope:d,runtime:p=!0,tags:o}=$.tagRule;s.enable=t,s.objectOfAction=l,s.ruleGranularity=d,s.runtime=p,console.log("tags",o),o&&o.length&&o.forEach((h,_)=>{r.value.push({tagName:h.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:f}=h;let c=[];f.forEach((i,y)=>{c.push({myKey:i.key,condition:Object.keys(i.value)[0],value:i.value[Object.keys(i.value)[0]]})}),r.value[_]&&r.value[_].scope&&(r.value[_].scope.labels=c)})}}),ye();const z=ve(),E=U(!1),G=U(8);ie().toClipboard;const q=(t,l)=>{var o,h,_,f;let d=`对于应用 ${l||"未指定"}，将满足 `;const p=[];if(((o=t.scope)==null?void 0:o.type)==="labels"&&((h=t.scope.labels)==null?void 0:h.length)>0)t.scope.labels.forEach(c=>{var k,m;let i="";if(c.myKey==="method")i="请求方法";else if((k=c.myKey)!=null&&k.startsWith("args[")){const T=(m=c.myKey.match(/\[(\d+)\]/))==null?void 0:m[1];T!==void 0?i=`第 ${parseInt(T)+1} 个参数`:i=`标签 ${c.myKey||"未指定"}`}else i=`标签 ${c.myKey||"未指定"}`;let y="";const v=c.value||"未指定";switch(c.condition){case"exact":y=`exact ${v}`;break;case"regex":y=`regex ${v}`;break;case"prefix":y=`prefix ${v}`;break;case"noempty":y="noempty";break;case"empty":y="empty";break;case"wildcard":y=`wildcard ${v}`;break;case"!=":y=`!= ${v}`;break;default:y=`${c.condition||"未知关系"} ${v}`}c.condition!=="empty"&&c.condition!=="noempty"&&!c.value?p.push(`${i} 未填写`):p.push(`${i} ${y}`)});else if(((_=t.scope)==null?void 0:_.type)==="addresses"&&((f=t.scope.addresses)!=null&&f.addressesStr)){const c=t.scope.addresses.condition==="="?"等于":"不等于";p.push(`地址 ${c} [${t.scope.addresses.addressesStr}]`)}return p.length===0?d+="任意请求":d+=p.join(" 且 "),d+=` 的实例，打上 ${t.tagName||"未指定"} 标签，划入 ${t.tagName||"未指定"} 的隔离环境`,d},s=be({ruleGranularity:"application",objectOfAction:"shop-user",enable:!0,faultTolerantProtection:!0,runtime:!0,priority:1,configVersion:""});Y(s,t=>{const{enable:l,objectOfAction:d,runtime:p,ruleGranularity:o}=t;$.tagRule={...$.tagRule,enabled:l,key:d,runtime:p,scope:o}});const M=U([{label:"labels",value:"labels"}]),Q=U([{label:"exact",value:"exact"},{label:"regex",value:"regex"},{label:"prefix",value:"prefix"},{label:"noempty",value:"noempty"},{label:"empty",value:"empty"},{label:"wildcard",value:"wildcard"}]),W=U([{label:"=",value:"="},{label:"!=",value:"!="}]),X=U([{title:"键",dataIndex:"myKey",key:"myKey"},{title:"关系",dataIndex:"condition",key:"condition"},{title:"值",dataIndex:"value",key:"value"},{title:"操作",dataIndex:"operation",key:"operation"}]),r=U([]);Y(r,t=>{console.log(t);const l=[];t.forEach(d=>{const{tagName:p,scope:o}=d,h=o.labels,_={name:p,match:[]};h&&h.length>0&&h.forEach(f=>{_.match.push({key:f.myKey,value:{[f.condition]:f.value}})}),l.push(_)}),$.tagRule={...$.tagRule,tags:l},console.log("watch tagList",$.tagRule)},{deep:!0});const Z=(t,l)=>{if(r.value[t].scope.labels.length===1){r.value[t].scope.type="addresses";return}r.value[t].scope.labels.splice(l,1)},I=t=>{r.value[t].scope.labels.push({myKey:"",condition:"exact",value:""})},ee=()=>{r.value.push({tagName:"",scope:{type:"labels",labels:[{myKey:"",condition:"",value:""}],addresses:{condition:"",addressesStr:""}}})},ae=t=>{r.value.splice(t,1)},F=async()=>{var l;const t=await Oe((l=z.params)==null?void 0:l.ruleName);if(t.code===200){const{configVersion:d,enabled:p,key:o,runtime:h,scope:_,tags:f}=t==null?void 0:t.data;s.configVersion=d,s.enable=p,s.runtime=h,s.ruleGranularity=_,s.objectOfAction=o,r.value=[],f.forEach((c,i)=>{r.value.push({tagName:c.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:y}=c;let v=[];y.forEach((k,m)=>{v.push({myKey:k.key,condition:Object.keys(k.value)[0],value:k.value[Object.keys(k.value)[0]]})}),r.value[i]&&r.value[i].scope&&(r.value[i].scope.labels=v)})}},te=async()=>{var i;const{ruleGranularity:t,objectOfAction:l,enable:d,faultTolerantProtection:p,runtime:o,priority:h,configVersion:_}=s,f={configVersion:_,scope:t,key:l,enabled:d,runtime:o,tags:[]};r.value.forEach((y,v)=>{const k={name:y.tagName,match:[]};y.scope.labels.forEach((m,T)=>{const D={key:m.myKey,value:{}};D.value[m.condition]=m.value,k.match.push(D)}),f.tags.push(k)}),(await Ke((i=z.params)==null?void 0:i.ruleName,f)).code===200&&(await F(),we.success("修改成功"))};return(t,l)=>{const d=u("a-button"),p=u("a-flex"),o=u("a-form-item"),h=u("a-switch"),_=u("a-col"),f=u("a-input"),c=u("a-input-number"),i=u("a-row"),y=u("a-form"),v=u("a-card"),k=u("a-tooltip"),m=u("a-space"),T=u("a-radio-group"),D=u("a-tag"),J=u("a-select"),le=u("a-table"),oe=u("a-textarea"),V=u("a-descriptions-item"),ne=u("a-descriptions"),se=u("a-affix");return g(),H("div",Ue,[e(p,{style:{width:"100%"}},{default:a(()=>[e(_,{span:E.value?24-G.value:24,class:"left"},{default:a(()=>[e(v,null,{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical",size:"middle"},{default:a(()=>[e(i,null,{default:a(()=>[e(p,{justify:"end",style:{width:"100%"}},{default:a(()=>[e(d,{type:"text",style:{color:"#0a90d5"},onClick:l[0]||(l[0]=n=>E.value=!E.value)},{default:a(()=>[b(" 字段说明 "),E.value?(g(),w(A(me),{key:1})):(g(),w(A(he),{key:0}))]),_:1})]),_:1}),e(v,{title:"基础信息",style:{width:"100%"},class:"_detail"},{default:a(()=>[e(y,{layout:"horizontal"},{default:a(()=>[e(i,{style:{width:"100%"}},{default:a(()=>[e(_,{span:12},{default:a(()=>[e(o,{label:"规则粒度",required:""},{default:a(()=>[b(" 应用")]),_:1}),e(o,{label:"容错保护"},{default:a(()=>[e(h,{checked:s.faultTolerantProtection,"onUpdate:checked":l[1]||(l[1]=n=>s.faultTolerantProtection=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(o,{label:"运行时生效"},{default:a(()=>[e(h,{checked:s.runtime,"onUpdate:checked":l[2]||(l[2]=n=>s.runtime=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})]),_:1}),e(_,{span:12},{default:a(()=>[e(o,{label:"作用对象",required:""},{default:a(()=>[e(f,{disabled:"",value:s.objectOfAction,"onUpdate:value":l[3]||(l[3]=n=>s.objectOfAction=n),style:{width:"200px"}},null,8,["value"])]),_:1}),e(o,{label:"立即启用"},{default:a(()=>[e(h,{checked:s.enable,"onUpdate:checked":l[4]||(l[4]=n=>s.enable=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(o,{label:"优先级"},{default:a(()=>[e(c,{min:"1",value:s.priority,"onUpdate:value":l[5]||(l[5]=n=>s.priority=n)},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(v,{title:"标签列表",style:{width:"100%"},class:"_detail"},{default:a(()=>[(g(!0),H(ke,null,ge(r.value,(n,j)=>(g(),w(v,{key:j},{title:a(()=>[e(m,{align:"center"},{default:a(()=>[x("div",null,"路由【"+B(j+1)+"】",1),e(k,null,{title:a(()=>[b(B(q(n,s.objectOfAction)),1)]),default:a(()=>[x("div",Ee,B(q(n,s.objectOfAction)),1)]),_:2},1024)]),_:2},1024)]),default:a(()=>[e(y,{layout:"horizontal"},{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical",size:"large"},{default:a(()=>[e(p,{justify:"end"},{default:a(()=>[e(A(L),{onClick:O=>ae(j),class:"action-icon",icon:"tdesign:delete"},null,8,["onClick"])]),_:2},1024),e(o,{label:"标签名",required:""},{default:a(()=>[e(f,{placeholder:"隔离环境名",value:n.tagName,"onUpdate:value":O=>n.tagName=O},null,8,["value","onUpdate:value"])]),_:2},1024),e(o,{label:"作用范围",required:""},{default:a(()=>[e(v,null,{default:a(()=>[e(m,{style:{width:"100%"},direction:"vertical"},{default:a(()=>[e(o,{label:"匹配条件类型"},{default:a(()=>[e(T,{value:n.scope.type,"onUpdate:value":O=>n.scope.type=O,options:M.value},null,8,["value","onUpdate:value","options"])]),_:2},1024),e(m,{align:"start",style:{width:"100%"},direction:"horizontal"},{default:a(()=>{var O;return[e(D,{bordered:!1,color:"processing"},{default:a(()=>[b(B(n.scope.type),1)]),_:2},1024),n.scope.type==="labels"?(g(),w(le,{key:0,pagination:!1,columns:X.value,"data-source":(O=n.scope)==null?void 0:O.labels},{bodyCell:a(({column:C,record:N,text:Be,index:ce})=>[C.key==="myKey"?(g(),w(f,{key:0,placeholder:"label key",value:N.myKey,"onUpdate:value":K=>N.myKey=K},null,8,["value","onUpdate:value"])):P("",!0),C.key==="condition"?(g(),w(J,{key:1,value:N.condition,"onUpdate:value":K=>N.condition=K,style:{width:"120px"},options:Q.value},null,8,["value","onUpdate:value","options"])):P("",!0),C.key==="value"?(g(),w(f,{key:2,placeholder:"label value",value:N.value,"onUpdate:value":K=>N.value=K},null,8,["value","onUpdate:value"])):C.key==="operation"?(g(),w(m,{key:3,align:"center"},{default:a(()=>[e(A(L),{icon:"tdesign:remove",class:"action-icon",onClick:K=>Z(j,ce)},null,8,["onClick"]),e(A(L),{class:"action-icon",icon:"tdesign:add",onClick:K=>I(j)},null,8,["onClick"])]),_:2},1024)):P("",!0)]),_:2},1032,["columns","data-source"])):(g(),w(m,{key:1,align:"start"},{default:a(()=>[e(J,{style:{width:"120px"},value:n.scope.addresses.condition,"onUpdate:value":C=>n.scope.addresses.condition=C,options:W.value},null,8,["value","onUpdate:value","options"]),e(oe,{style:{width:"500px"},value:n.scope.addresses.addressesStr,"onUpdate:value":C=>n.scope.addresses.addressesStr=C,placeholder:'地址列表，如有多个用"，"隔开'},null,8,["value","onUpdate:value"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(d,{onClick:ee,type:"primary"},{default:a(()=>[b(" 增加标签")]),_:1})]),_:1})]),_:1})]),_:1},8,["span"]),e(_,{span:E.value?G.value:0,class:"right"},{default:a(()=>[E.value?(g(),w(v,{key:0,class:"sliderBox"},{default:a(()=>[x("div",null,[e(ne,{title:"字段说明",column:1},{default:a(()=>[e(V,{label:"key"},{default:a(()=>[b(" 作用对象"),Ne,b(" 可能的值：Dubbo应用名或者服务名 ")]),_:1}),e(V,{label:"scope"},{default:a(()=>[b(" 规则粒度"),Re,b(" 可能的值：application, service ")]),_:1}),e(V,{label:"force"},{default:a(()=>[b(" 容错保护"),Te,b(" 可能的值：true, false"),je,b(" 描述：如果为true，则路由筛选后若没有可用的地址则会直接报异常；如果为false，则会从可用地址中选择完成RPC调用 ")]),_:1}),e(V,{label:"runtime"},{default:a(()=>[b(" 运行时生效"),Ae,b(" 可能的值：true, false"),Se,b(" 描述：如果为true，则该rule下的所有路由将会实时生效；若为false，则只有在启动时才会生效 ")]),_:1})]),_:1})])]),_:1})):P("",!0)]),_:1},8,["span"])]),_:1}),e(se,{"offset-bottom":10},{default:a(()=>[x("div",De,[e(m,{align:"center",size:"large"},{default:a(()=>[e(d,{type:"primary",onClick:te},{default:a(()=>[b(" 确认")]),_:1}),e(d,null,{default:a(()=>[b(" 取消")]),_:1})]),_:1})])]),_:1})])}}}),qe=$e(Ve,[["__scopeId","data-v-5efc185c"]]);export{qe as default};
